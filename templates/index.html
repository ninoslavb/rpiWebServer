<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/sidebar.css?v=1122311333133231222324" />
    <link rel="stylesheet" href="/static/master.css?v=142212112312312224141234231231" />
    <link rel="stylesheet" href="/static/rules.css?v=121112312356711212312355233" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    <script src="/static/test.js"></script>
    <script>
      //Parse device_data rendered in WebServer.py to json file so it is acessible in .js files throuh deviceData
      const deviceData = JSON.parse('{{ device_data | tojson | safe }}'); 
      let ruleData = JSON.parse('{{ rule_data | tojson | safe }}'); 
    </script>
    
    <script type="module" src="/static/main.js"></script>
    <script type="module" src="/static/rules.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
   
  </head>
  <body>
<div id="wrapper">
  <button class="sidebar-toggle" onclick="toggleSidebar()">&#9776;</button>
    <div class="sidebar collapsed" id="sidebar">
      <ul>
        <li><button onclick="navigate('dashboard')">Dashboard</button></li>
        <li><button onclick="navigate('groups')">Groups</button></li>
        <li><button onclick="navigate('if-this-then-this')">Rules</button></li>
      </ul>
    </div>
    
<div class="main-content expanded" id="main-content">


      <div id="dashboard">    
        <h1>Dashboard</h1>
        <div class="device-container">  

           {% for device_key, device in device_data.items() if device['type'] == 'output' %}
              <div class="device-box" data-id="{{ device['box_id'] }}">
                <div class="device-label">{{ device['gpio_id'] }}</div>
                <div class="device-top">
                  <div class="device-name">
                    <input class="device-input" type="text" placeholder="Enter name" id="{{ device_key }}-name" value="{{ device['name'] }}">
                  </div>
                  <div class="device-icon">
                    <i class="fas fa-lightbulb" style="color: #FFFFFF;"></i>
                  </div>
                  <label class="device-switch">
                    <input type="checkbox" id="{{ device_key }}-input">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
            {% endfor %}

          
            {% for device_key, device in device_data.items() if device['type'] == 'input' %}
              <div class="device-box" data-id="{{ device['box_id'] }}">
                <div class="device-label">{{ device['gpio_id'] }}</div>
                <div class="device-top">
                  <div class="device-name">
                    <input class="device-input" type="text" placeholder="Enter name" id="{{ device_key }}-name" value="{{ device['name'] }}">
                  </div>
                  <div class="device-icon">
                    <i class="fa-solid fa-door-open" style="color: #FFFFFF;"></i>
                  </div>
                </div>
              </div>
            {% endfor %}


        </div>  
      </div>     

      <div id="groups" style="display:none;">
        <!-- Your Groups page code goes here -->
      </div>

     <script>

/* 
The addInputDeviceRow function creates a new input device row with a dropdown for selecting an input device and another dropdown for selecting the input device state (0 or 1). 
It also adds a remove button to delete the input device row.
The updateInputDeviceOptions function disables the input device options that are already selected in other dropdowns. 
This is done by first collecting all the selected input devices in a set and then looping through all the input device selects and disabling the options that are already selected.
The event listener at the end of the code listens for changes in the input device
*/
// This function creates a new input device row and adds it to the inputDeviceWrapper
function addInputDeviceRow() {
  const inputDeviceWrapper = document.getElementById('inputDeviceWrapper');
  const inputDeviceRow = document.createElement('div');
  inputDeviceRow.classList.add('input-device-row');

  // Create a dropdown to select an input device
  const inputDeviceSelect = document.createElement('select');
  inputDeviceSelect.classList.add('input-device-select');
  //inputDeviceSelect.innerHTML = `<option disabled selected>Select Input Device</option>`;
  //inputDeviceSelect.innerHTML = `<option disabled selected data-placeholder>Select Input Device</option>`;
  inputDeviceSelect.innerHTML = `<option disabled selected class="placeholder-option">Select Input Device</option>`;
  for (const deviceKey in deviceData) {
    const device = deviceData[deviceKey];
    if (device.type === 'input') {
      const optionDevice = document.createElement("option");
      optionDevice.value = deviceKey;
      optionDevice.textContent = device.name;
      inputDeviceSelect.appendChild(optionDevice);
    }
  }
  inputDeviceRow.appendChild(inputDeviceSelect);

  // Create a dropdown to select the input device state (0 or 1)
  const inputDeviceOption = document.createElement('select');
  inputDeviceOption.classList.add('input-device-option');
  inputDeviceOption.innerHTML = `
    <option disabled selected>Select State</option>
    <option value="0">0</option>
    <option value="1">1</option>
  `;
  inputDeviceRow.appendChild(inputDeviceOption);

  // Create a remove button to delete the input device row
  const removeButton = document.createElement('button');
  removeButton.type = 'button';
  removeButton.textContent = 'Remove';
  removeButton.classList.add('btn', 'btn-sm', 'custom-delete-input-button');
  removeButton.addEventListener('click', () => {
    inputDeviceWrapper.removeChild(inputDeviceRow);
    updateInputDeviceOptions();
  });
  inputDeviceRow.appendChild(removeButton);

  // Add the input device row to the inputDeviceWrapper and update the input device options
  inputDeviceWrapper.appendChild(inputDeviceRow);
  updateInputDeviceOptions();
  //updateLogicOperatorVisibility();
}

// This function updates the input device options to disable the options that are already selected
function updateInputDeviceOptions() {
  const selectedInputDevices = new Set();
  const inputDeviceSelectElements = document.getElementsByClassName('input-device-select');

  // Loop through all input device selects and add their values to the selectedInputDevices set
  for (const selectElement of inputDeviceSelectElements) {
    if (selectElement.value !== "") {
      selectedInputDevices.add(selectElement.value);
    }
  }

  // Loop through all input device selects and disable the options that are already selected
for (const selectElement of inputDeviceSelectElements) {
  for (const optionElement of selectElement.options) {
    // Check if the optionElement has the custom class
    const isPlaceholder = optionElement.classList.contains("placeholder-option");

    if (!isPlaceholder && optionElement.value !== "" && selectedInputDevices.has(optionElement.value)) {
      optionElement.disabled = selectElement.value !== optionElement.value;
    } else {
      optionElement.disabled = isPlaceholder;
    }
  }
}
//updateLogicOperatorVisibility();
}

// Event listener to update the input device options when a dropdown value changes
document.addEventListener('change', (event) => {
  if (event.target.classList.contains('input-device-select')) {
    updateInputDeviceOptions();
  }
});


/*
function updateLogicOperatorVisibility() {
  const inputDeviceSelectElements = document.getElementsByClassName('input-device-select');
  const logicOperatorSelect = document.getElementById('logic-operator-select');
  
  let selectedDevicesCount = 0;
  for (const selectElement of inputDeviceSelectElements) {
    if (selectElement.value !== "") {
      selectedDevicesCount++;
    }
  }
  
  if (selectedDevicesCount > 1) {
    logicOperatorSelect.style.display = 'block';
  } else {
    logicOperatorSelect.style.display = 'none';
  }
}
*/



     </script>

      <!-- RULES -->
<!-- RULES -->
<div id="if-this-then-this" class="tab-content" style="display:none;">
  <div id="rules">
    <h2>Rules</h2>
    <button type="button" id="add-new-rule-button" class="custom-add-new-rule-button">ADD NEW RULE</button>
    <div id="add-rule-container" style="display: none;">
      <form id="add-rule-form">
        <div id="inputDeviceWrapper">
          <label for="input">Input devices:</label>
          <!-- The input-device-row elements will be added here when the "Add Input Device" button is clicked -->
          <button type="button" id="addInputDeviceButton" class="custom-add-input-device-button">Add Input Device</button>
        </div>

        <div id="logicOperatorWrapper">
          <label for="logicOperator">Logic operation between inputs:</label>
          <select class="logic-operator-select">
            <option disabled selected>Select Logic</option>
            <option value="AND">AND</option>
            <option value="OR">OR</option>
          </select>
        </div>

        <div id="outputWrapper">  
          <label for="output">Output device:</label>
          <div class="output-device-row">
          <select class="output-select">
            <option disabled selected>Select Output Device</option>
            {% for device_key, device in device_data.items() %}
            {% if device.type == 'output' %}
            <option value="{{ device_key }}">{{ device.name }}</option>
            {% endif %}
            {% endfor %}
          </select>
          <select class="output-action-select">
            <option disabled selected>Select Action</option>
            <option value="0">0</option>
            <option value="1">1</option>
          </select>
        </div>
      </div>
        <br><br>
        <button type="submit" class="custom-submit-rule-button">Submit rule</button>
      </form>
    </div>
    <h3>Current Rules:</h3>
    <ul id="rule-list">
      <!-- Rules will be added here via JavaScript -->
    </ul>
  </div>
</div>

 </div>
      
</div>

      
</div>
</div>


<script src="/static/sortBoxes_handler.js"></script>
<script src="/static/sidebar_handler.js"></script>
  
</body>
</html>